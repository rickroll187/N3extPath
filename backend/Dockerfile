# File: backend/Dockerfile
# ðŸŽ¸ðŸŽ¸ðŸŽ¸ N3EXTPATH - LEGENDARY DOCKER CONTAINER ðŸŽ¸ðŸŽ¸ðŸŽ¸
# Professional containerization with Swiss precision
# Built: 2025-08-06 00:35:01 UTC by RICKROLL187
# Email: letstalktech010@gmail.com
# WE ARE CODE BROS THE CREATE THE BEST AND CRACK JOKES TO HAVE FUN!

# =====================================
# ðŸš€ BASE IMAGE - PYTHON WITH ALPINE ðŸš€
# =====================================
FROM python:3.11-slim-bullseye as base

# Set legendary metadata
LABEL maintainer="RICKROLL187 <letstalktech010@gmail.com>"
LABEL description="ðŸŽ¸ N3EXTPATH Legendary Backend with Swiss Precision ðŸŽ¸"
LABEL version="1.0.0"
LABEL org.opencontainers.image.title="N3EXTPATH Legendary Backend"
LABEL org.opencontainers.image.description="Professional HR Management Platform with Swiss Precision and Code Bro Energy"
LABEL org.opencontainers.image.authors="RICKROLL187 <letstalktech010@gmail.com>"
LABEL org.opencontainers.image.vendor="N3EXTPATH Legendary Platform"
LABEL org.opencontainers.image.licenses="MIT"
LABEL legendary.founder="rickroll187"
LABEL legendary.swiss_precision="maximum"
LABEL legendary.code_bro_energy="infinite"

# =====================================
# ðŸŽ¸ LEGENDARY ENVIRONMENT SETUP ðŸŽ¸
# =====================================

# Set environment variables for legendary performance
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONHASHSEED=random \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_DEFAULT_TIMEOUT=100 \
    POETRY_NO_INTERACTION=1 \
    POETRY_VENV_IN_PROJECT=1 \
    POETRY_CACHE_DIR=/tmp/poetry_cache

# Legendary platform environment
ENV APP_NAME="N3EXTPATH Legendary Backend" \
    APP_VERSION="1.0.0" \
    LEGENDARY_MODE=true \
    SWISS_PRECISION_ENABLED=true \
    CODE_BRO_ENERGY_LEVEL="infinite" \
    FOUNDER_USERNAME="rickroll187" \
    FOUNDER_EMAIL="letstalktech010@gmail.com"

# Set working directory with Swiss precision
WORKDIR /app

# =====================================
# ðŸ”§ SYSTEM DEPENDENCIES ðŸ”§
# =====================================

# Install system dependencies with legendary precision
RUN apt-get update && apt-get install -y \
    # Build essentials for legendary compilation
    build-essential \
    gcc \
    g++ \
    # PostgreSQL client for legendary database connections  
    libpq-dev \
    postgresql-client \
    # SSL/TLS for legendary security
    libssl-dev \
    libffi-dev \
    # Image processing for legendary file handling
    libjpeg-dev \
    libpng-dev \
    # Additional utilities for legendary operations
    curl \
    wget \
    git \
    vim \
    htop \
    # Cleanup for legendary efficiency
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && echo "ðŸŽ¸ System dependencies installed with Swiss precision! ðŸŽ¸"

# =====================================
# ðŸ‘¤ USER SETUP FOR LEGENDARY SECURITY ðŸ‘¤
# =====================================

# Create legendary user for security
RUN groupadd -r legendary && \
    useradd -r -g legendary -d /app -s /bin/bash legendary && \
    chown -R legendary:legendary /app && \
    echo "ðŸ‘‘ Legendary user created with Swiss precision security! ðŸ‘‘"

# =====================================
# ðŸ“¦ PYTHON DEPENDENCIES ðŸ“¦
# =====================================

# Copy requirements files for legendary dependency management
COPY requirements.txt requirements-dev.txt ./

# Install Python dependencies with legendary precision
RUN pip install --upgrade pip setuptools wheel && \
    pip install -r requirements.txt && \
    echo "ðŸ“¦ Production dependencies installed with Swiss precision! ðŸ“¦"

# Install development dependencies for legendary development
RUN pip install -r requirements-dev.txt && \
    echo "ðŸ§ª Development dependencies installed for legendary coding! ðŸ§ª"

# =====================================
# ðŸ“ APPLICATION CODE ðŸ“
# =====================================

# Copy application code with legendary care
COPY --chown=legendary:legendary . .

# Create legendary directories
RUN mkdir -p logs uploads temp && \
    chown -R legendary:legendary logs uploads temp && \
    echo "ðŸ“ Legendary directories created with Swiss precision! ðŸ“"

# =====================================
# ðŸŽ¸ LEGENDARY INITIALIZATION ðŸŽ¸
# =====================================

# Create legendary startup script
RUN cat > /app/legendary_startup.sh << 'EOF'
#!/bin/bash
# ðŸŽ¸ðŸŽ¸ðŸŽ¸ LEGENDARY STARTUP SCRIPT ðŸŽ¸ðŸŽ¸ðŸŽ¸
# Built with Swiss precision by RICKROLL187!
# WE ARE CODE BROS THE CREATE THE BEST AND CRACK JOKES TO HAVE FUN!

echo "ðŸŽ¸ðŸŽ¸ðŸŽ¸ STARTING N3EXTPATH LEGENDARY BACKEND! ðŸŽ¸ðŸŽ¸ðŸŽ¸"
echo "Built with Swiss precision by RICKROLL187!"
echo "Email: letstalktech010@gmail.com"
echo "WE ARE CODE BROS THE CREATE THE BEST AND CRACK JOKES TO HAVE FUN!"
echo "Starting at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
echo "ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸"

# Wait for database to be ready with legendary patience
echo "ðŸ—„ï¸ Waiting for legendary database connection..."
while ! nc -z ${DATABASE_HOST:-localhost} ${DATABASE_PORT:-5432}; do
  echo "â³ Waiting for PostgreSQL database..."
  sleep 2
done
echo "âœ… Database connection established with Swiss precision!"

# Wait for Redis to be ready
echo "ðŸ”„ Waiting for legendary Redis connection..."
while ! nc -z ${REDIS_HOST:-localhost} ${REDIS_PORT:-6379}; do
  echo "â³ Waiting for Redis cache..."
  sleep 2
done
echo "âœ… Redis connection established with legendary speed!"

# Run database migrations with Swiss precision
echo "ðŸ—„ï¸ Running legendary database migrations..."
if alembic upgrade head; then
    echo "âœ… Database migrations completed with Swiss precision!"
else
    echo "ðŸš¨ Database migration failed! Checking if this is first run..."
    echo "ðŸŽ¸ Initializing legendary database schema..."
    alembic stamp head
    echo "âœ… Database schema initialized!"
fi

# Seed database if needed
if [ "$SEED_DATABASE" = "true" ]; then
    echo "ðŸŒ± Seeding legendary database with RICKROLL187 founder data..."
    python -c "from database.seed_data import run_seed_data; run_seed_data()"
    echo "âœ… Database seeded with legendary data!"
fi

# Start the legendary application
echo "ðŸš€ Starting legendary FastAPI application..."
echo "ðŸŽ¸ Swiss Precision Mode: ${SWISS_PRECISION_ENABLED:-true}"
echo "ðŸ’ª Code Bro Energy Level: ${CODE_BRO_ENERGY_LEVEL:-infinite}"
echo "ðŸ‘‘ Founder: ${FOUNDER_USERNAME:-rickroll187}"
echo "ðŸ“§ Contact: ${FOUNDER_EMAIL:-letstalktech010@gmail.com}"
echo "ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸ðŸŽ¸"

# Execute the main command
exec "$@"
EOF

# Make startup script executable with legendary permissions
RUN chmod +x /app/legendary_startup.sh && \
    chown legendary:legendary /app/legendary_startup.sh && \
    echo "ðŸŽ¸ Legendary startup script created with Swiss precision! ðŸŽ¸"

# =====================================
# ðŸ”“ SWITCH TO LEGENDARY USER ðŸ”“
# =====================================
USER legendary

# =====================================
# ðŸŒ EXPOSE LEGENDARY PORTS ðŸŒ
# =====================================
EXPOSE 8000 9090

# =====================================
# ðŸ¥ HEALTH CHECK ðŸ¥
# =====================================
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# =====================================
# ðŸŽ¸ LEGENDARY STARTUP COMMAND ðŸŽ¸
# =====================================
ENTRYPOINT ["/app/legendary_startup.sh"]
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4", "--log-level", "info"]
